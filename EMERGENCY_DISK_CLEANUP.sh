#!/bin/bash
set -e

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║  🚨 ЭКСТРЕННАЯ ОЧИСТКА ДИСКА                                   ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

echo "📊 Проверка использования диска..."
df -h

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 1: Остановка контейнеров..."
docker-compose down

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 2: Очистка Docker (неиспользуемые образы, контейнеры, volumes)..."
docker system prune -af --volumes
docker volume prune -f

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 3: Очистка логов Docker..."
if [ -d "/var/lib/docker/containers" ]; then
    echo "Очистка логов контейнеров..."
    find /var/lib/docker/containers -name "*.log" -type f -delete
    echo "✅ Логи контейнеров очищены"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 4: Очистка системных логов..."
sudo journalctl --vacuum-time=1d
sudo journalctl --vacuum-size=100M

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 5: Очистка логов приложения..."
if [ -d "logs" ]; then
    rm -f logs/*.log
    echo "✅ Логи приложения очищены"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 6: Очистка временных файлов..."
if [ -d "processed_images" ]; then
    rm -f processed_images/*
    echo "✅ Обработанные изображения очищены"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧹 Шаг 7: Очистка APT кеша..."
sudo apt-get clean
sudo apt-get autoclean
sudo apt-get autoremove -y

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 РЕЗУЛЬТАТ:"
df -h

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║  ✅ ОЧИСТКА ЗАВЕРШЕНА!                                         ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
echo "🔄 Теперь можно запустить контейнер:"
echo "   docker-compose up -d"
echo ""
