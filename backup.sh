#!/bin/bash

# üíæ –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞
# –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –ø—Ä–æ–µ–∫—Ç–∞ –≤–∫–ª—é—á–∞—è .env –∏ session —Ñ–∞–π–ª—ã

set -e

BACKUP_DIR="backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="telegram-copier-backup-$TIMESTAMP"
BACKUP_FILE="$BACKUP_DIR/$BACKUP_NAME.tar.gz"

echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ Telegram Post Copier"
echo "========================================"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p $BACKUP_DIR

# –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±—ç–∫–∞–ø–∞
echo ""
echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±—ç–∫–∞–ø–∞..."

FILES_TO_BACKUP=(
    "*.py"
    "*.md"
    "*.sh"
    "*.txt"
    ".env"
    "*.session"
    "*.session-journal"
    "requirements.txt"
    "Dockerfile"
    "docker-compose.yml"
    ".dockerignore"
    ".gitignore"
    "Makefile"
    "env.example"
    "LICENSE"
)

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
TEMP_DIR=$(mktemp -d)
TEMP_BACKUP="$TEMP_DIR/$BACKUP_NAME"
mkdir -p "$TEMP_BACKUP"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
for pattern in "${FILES_TO_BACKUP[@]}"; do
    for file in $pattern; do
        if [ -f "$file" ]; then
            cp "$file" "$TEMP_BACKUP/" 2>/dev/null || true
        fi
    done
done

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .github
if [ -d ".github" ]; then
    cp -r .github "$TEMP_BACKUP/" 2>/dev/null || true
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
echo ""
echo "‚ÑπÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞..."
cat > "$TEMP_BACKUP/BACKUP_INFO.txt" << EOF
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë          TELEGRAM POST COPIER - BACKUP INFO                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: $(date '+%Y-%m-%d %H:%M:%S')
üíª Hostname: $(hostname)
üë§ User: $(whoami)
üìÅ –ò—Å—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)

üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—ç–∫–∞–ø–∞:
$(ls -1 "$TEMP_BACKUP" | sed 's/^/  ‚úì /')

üîê –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã:
$(ls -1 "$TEMP_BACKUP"/.env 2>/dev/null | sed 's/^/  ‚úì /' || echo "  ‚ö†Ô∏è  .env –Ω–µ –Ω–∞–π–¥–µ–Ω")
$(ls -1 "$TEMP_BACKUP"/*.session 2>/dev/null | sed 's/^/  ‚úì /' || echo "  ‚ö†Ô∏è  Session —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
  ‚Ä¢ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(find "$TEMP_BACKUP" -type f | wc -l | xargs)
  ‚Ä¢ –†–∞–∑–º–µ—Ä: $(du -sh "$TEMP_BACKUP" | cut -f1)

üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:
  1. –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–π—Ç–µ: tar -xzf $BACKUP_NAME.tar.gz
  2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: cd $BACKUP_NAME
  3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: bash restore.sh

‚ö†Ô∏è  –í–ê–ñ–ù–û:
  ‚Ä¢ –•—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ
  ‚Ä¢ –§–∞–π–ª .env —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏
  ‚Ä¢ Session —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é Telegram
  ‚Ä¢ –ù–ï –¥–µ–ª–∏—Ç–µ—Å—å –±—ç–∫–∞–ø–æ–º –ø—É–±–ª–∏—á–Ω–æ

EOF

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
cat > "$TEMP_BACKUP/restore.sh" << 'EOF'
#!/bin/bash

# üîÑ –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞

set -e

echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Telegram Post Copier –∏–∑ –±—ç–∫–∞–ø–∞"
echo "================================================"

TARGET_DIR="../telegram-post-copier-restored"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ -d "$TARGET_DIR" ]; then
    echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $TARGET_DIR —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    read -p "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
    rm -rf "$TARGET_DIR"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo ""
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $TARGET_DIR..."
mkdir -p "$TARGET_DIR"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
cp -r * "$TARGET_DIR/" 2>/dev/null || true
cp -r .* "$TARGET_DIR/" 2>/dev/null || true

# –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -f "$TARGET_DIR/restore.sh" 2>/dev/null || true
rm -f "$TARGET_DIR/BACKUP_INFO.txt" 2>/dev/null || true

cd "$TARGET_DIR"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
chmod 600 .env 2>/dev/null || true
chmod 600 *.session 2>/dev/null || true
chmod +x *.sh 2>/dev/null || true

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p temp processed_images logs

echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  ‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!                              ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  üìÅ –§–∞–π–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤: $TARGET_DIR                     ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:                                        ‚ïë"
echo "‚ïë     1. cd $TARGET_DIR                                      ‚ïë"
echo "‚ïë     2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env —Ñ–∞–π–ª                                 ‚ïë"
echo "‚ïë     3. bash setup.sh (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)                          ‚ïë"
echo "‚ïë     4. python copier.py –∏–ª–∏ docker-compose up -d           ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
EOF

chmod +x "$TEMP_BACKUP/restore.sh"

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
echo ""
echo "üóúÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞..."
cd "$TEMP_DIR"
tar -czf "$BACKUP_FILE" "$BACKUP_NAME" 2>/dev/null

# –ü–µ—Ä–µ—Ö–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ
cd - > /dev/null

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -rf "$TEMP_DIR"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—ç–∫–∞–ø–µ
BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)

echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  ‚úÖ –ë–≠–ö–ê–ü –°–û–ó–î–ê–ù –£–°–ü–ï–®–ù–û!                                  ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  üì¶ –§–∞–π–ª: $BACKUP_FILE                                     ‚ïë"
echo "‚ïë  üìä –†–∞–∑–º–µ—Ä: $BACKUP_SIZE                                   ‚ïë"
echo "‚ïë  üìÖ –î–∞—Ç–∞: $TIMESTAMP                                       ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:                                        ‚ïë"
echo "‚ïë     tar -xzf $BACKUP_FILE                                  ‚ïë"
echo "‚ïë     cd $BACKUP_NAME                                        ‚ïë"
echo "‚ïë     bash restore.sh                                        ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïë  ‚òÅÔ∏è  –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:                   ‚ïë"
echo "‚ïë     ‚Ä¢ –í–Ω–µ—à–Ω–∏–π –¥–∏—Å–∫                                         ‚ïë"
echo "‚ïë     ‚Ä¢ –û–±–ª–∞–∫–æ (Dropbox, Google Drive, etc.)                 ‚ïë"
echo "‚ïë     ‚Ä¢ –î—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä                                        ‚ïë"
echo "‚ïë                                                            ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

# –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
echo ""
echo "üìã –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤:"
ls -lh $BACKUP_DIR/*.tar.gz 2>/dev/null | awk '{print "  ‚Ä¢ " $9 " (" $5 ")"}'

echo ""
echo "üí° –°–æ–≤–µ—Ç: –†–µ–≥—É–ª—è—Ä–Ω–æ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –±—ç–∫–∞–ø—ã (–æ—Å–æ–±–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏)"
echo "üí° –î–æ–±–∞–≤—å—Ç–µ –≤ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤:"
echo "   0 3 * * * cd $(pwd) && bash backup.sh"

