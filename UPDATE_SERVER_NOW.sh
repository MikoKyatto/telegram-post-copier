#!/bin/bash
set -e

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║  🚀 АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ КОНТЕЙНЕРА                       ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

SERVER="root@80.92.204.27"
PROJECT_DIR="/opt/telegram-post-copier"

echo "📡 Подключение к серверу ${SERVER}..."
echo ""

ssh $SERVER << 'ENDSSH'
cd /opt/telegram-post-copier

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1️⃣  Обновление кода с GitHub..."
git pull origin main
echo "✅ Код обновлен"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2️⃣  Остановка старого контейнера..."
docker-compose down
echo "✅ Контейнер остановлен"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3️⃣  Пересборка контейнера (без кеша)..."
docker-compose build --no-cache
echo "✅ Контейнер собран"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4️⃣  Запуск контейнера..."
docker-compose up -d
echo "✅ Контейнер запущен"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "5️⃣  Проверка логов (первые 30 строк)..."
echo ""
sleep 3
docker-compose logs --tail=30

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║  ✅ ОБНОВЛЕНИЕ ЗАВЕРШЕНО!                                      ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
echo "📊 Смотрите полные логи:"
echo "   docker-compose logs -f"
echo ""
ENDSSH

echo "🎉 Готово! Контейнер обновлен и запущен."
